{% extends 'layout.html' %}

{% block title %}Lista de Soportes{% endblock %}

{% block content %}
    <h1>ðŸ“‹ Lista de Soportes</h1>

    <!-- Panel de Reportes y Filtros -->
    <div class="report-panel">
        <form method="post" id="filter-form">
            <div class="form-row">
                <div class="form-group">
                    <label for="start_date">Desde:</label>
                    <input type="date" id="start_date" name="start_date" value="{{ start_date or '' }}">
                </div>
                <div class="form-group">
                    <label for="end_date">Hasta:</label>
                    <input type="date" id="end_date" name="end_date" value="{{ end_date or '' }}">
                </div>
                <div class="form-group">
                    <label for="categoria">CategorÃ­a:</label>
                    <select id="categoria" name="categoria">
                        <option value="todas">-- Todas --</option>
                        {% for cat in categorias %}
                        <option value="{{ cat }}" {% if selected_category == cat %}selected{% endif %}>{{ cat }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-primary">Filtrar Lista</button>
                </div>
            </div>
        </form>
        <div class="action-buttons">
            <a id="export-excel" href="#" class="btn btn-success">Exportar a Excel</a>
            <a id="export-pdf" href="#" class="btn btn-danger">Exportar a PDF</a>
            <button id="print-btn" class="btn btn-secondary">Imprimir</button>
        </div>
    </div>
    
    <!-- Tabla de Soportes -->
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Estado</th>
                <th>Usuario</th>
                <th>Problema</th>
                <th>Fecha Inicio</th>
                <th>Fecha Fin</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for ticket in soportes %}
            <tr>
                <td>{{ ticket.id }}</td>
                <td>{{ ticket.estado }}</td>
                <td>{{ ticket.usuario }}</td>
                <td>{{ ticket.problema }}</td>
                <td>{{ ticket.fecha_inicio }}</td>
                <td>{{ ticket.fecha_finalizacion or 'Pendiente' }}</td>
                <td>
                    <a href="{{ url_for('editar', ticket_id=ticket.id) }}" class="btn btn-edit">Editar</a>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="7" style="text-align: center;">No se encontraron soportes con los criterios seleccionados.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- PaginaciÃ³n (solo se muestra si no es un reporte filtrado) -->
    {% if total_pages > 1 and not is_report %}
    <nav class="pagination">
        <a href="{{ url_for('lista_soportes', page=page-1) }}" class="{{ 'disabled' if page == 1 else '' }}">&laquo; Anterior</a>
        {% for p in range(1, total_pages + 1) %}
            <a href="{{ url_for('lista_soportes', page=p) }}" class="{{ 'active' if p == page else '' }}">{{ p }}</a>
        {% endfor %}
        <a href="{{ url_for('lista_soportes', page=page+1) }}" class="{{ 'disabled' if page == total_pages else '' }}">Siguiente &raquo;</a>
    </nav>
    {% endif %}

{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const printBtn = document.getElementById('print-btn');
        if (printBtn) {
            printBtn.addEventListener('click', function() { window.print(); });
        }

        function updateExportLinks() {
            const startDate = document.getElementById('start_date').value;
            const endDate = document.getElementById('end_date').value;
            const category = document.getElementById('categoria').value;
            const params = new URLSearchParams({ start_date: startDate, end_date: endDate, categoria: category });
            const excelLink = document.getElementById('export-excel');
            const pdfLink = document.getElementById('export-pdf');
            if (excelLink) { excelLink.href = "{{ url_for('exportar_excel') }}?" + params.toString(); }
            if (pdfLink) { pdfLink.href = "{{ url_for('exportar_pdf') }}?" + params.toString(); }
        }

        document.getElementById('start_date').addEventListener('change', updateExportLinks);
        document.getElementById('end_date').addEventListener('change', updateExportLinks);
        document.getElementById('categoria').addEventListener('change', updateExportLinks);
        updateExportLinks();
    });
</script>
{% endblock %}
