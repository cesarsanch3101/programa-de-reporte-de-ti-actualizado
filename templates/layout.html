<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soporte TI | Enterprise</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.4.1/css/responsive.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.3.6/css/buttons.bootstrap5.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">


    <script>
        // Init theme immediately to prevent flashing
        (function () {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
        })();
    </script>
</head>

<body>

    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <div class="app-wrapper">
        {% if session.get('user_id') %}
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <img src="{{ url_for('static', filename='img/logo.png') }}" alt="Logo" class="sidebar-logo">
                <h1 class="sidebar-title">Soporte TI</h1>
            </div>

            <div class="sidebar-menu">
                <div class="menu-section">Principal</div>
                <div class="menu-item">
                    <a href="{{ url_for('dashboard') }}"
                        class="menu-link {% if request.endpoint == 'dashboard' %}active{% endif %}">
                        <i class="fas fa-th-large"></i> Dashboard
                    </a>
                </div>
                <div class="menu-item">
                    <a href="{{ url_for('lista_soportes') }}"
                        class="menu-link {% if request.endpoint == 'lista_soportes' %}active{% endif %}">
                        <i class="fas fa-ticket-alt"></i> Mis Tickets
                    </a>
                </div>

                {% if session.get('role') in ['admin', 'tecnico'] %}
                <div class="menu-section">Gesti√≥n T√©cnica</div>
                <div class="menu-item">
                    <a href="{{ url_for('lista_equipos') }}"
                        class="menu-link {% if request.endpoint == 'lista_equipos' %}active{% endif %}">
                        <i class="fas fa-laptop"></i> Inventario
                    </a>
                </div>
                <div class="menu-item">
                    <a href="{{ url_for('lista_mantenimientos') }}"
                        class="menu-link {% if request.endpoint == 'lista_mantenimientos' %}active{% endif %}">
                        <i class="fas fa-tools"></i> Mantenimientos
                    </a>
                </div>
                <div class="menu-item">
                    <a href="{{ url_for('ver_calendario') }}"
                        class="menu-link {% if request.endpoint == 'ver_calendario' %}active{% endif %}">
                        <i class="far fa-calendar-alt"></i> Calendario
                    </a>
                </div>
                {% endif %}

                {% if session.get('role') == 'admin' %}
                <div class="menu-section">Sistema</div>
                <div class="menu-item">
                    <a href="{{ url_for('admin_usuarios') }}"
                        class="menu-link {% if request.endpoint == 'admin_usuarios' %}active{% endif %}">
                        <i class="fas fa-users-cog"></i> Usuarios
                    </a>
                </div>
                <div class="menu-item">
                    <a href="{{ url_for('admin_config_email') }}"
                        class="menu-link {% if request.endpoint == 'admin_config_email' %}active{% endif %}">
                        <i class="fas fa-envelope-open-text"></i> Email Config
                    </a>
                </div>
                {% endif %}
            </div>
        </aside>
        {% endif %}

        <div class="main-content">
            {% if session.get('user_id') %}
            <!-- Top Bar -->
            <header class="top-bar">
                <div class="d-flex align-items-center">
                    <button class="btn btn-sm btn-light d-lg-none me-3" id="sidebarToggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h5 class="mb-0 text-muted small fw-bold text-uppercase d-none d-md-block">
                        {% if request.endpoint == 'dashboard' %}Panel de Control
                        {% elif request.endpoint == 'lista_soportes' %}Gesti√≥n de Tickets
                        {% elif request.endpoint == 'lista_equipos' %}Fichas de Inventario
                        {% elif request.endpoint == 'lista_mantenimientos' %}Cronograma de Tareas
                        {% else %}Sistema de Gesti√≥n TI{% endif %}
                    </h5>
                </div>

                <div class="user-profile dropdown d-flex align-items-center">
                    <!-- Theme Toggle -->
                    <button class="btn btn-link text-muted me-3 p-0 border-0 shadow-none" id="themeToggle"
                        title="Cambiar Tema">
                        <i class="fas fa-moon fs-5" id="themeIcon"></i>
                    </button>

                    <div class="d-flex flex-column text-end me-3 d-none d-sm-flex">
                        <span class="fw-bold small">{{ session.get('username') }}</span>
                        <span class="text-muted" style="font-size: 0.75rem;">{{ session.get('role') | capitalize
                            }}</span>
                    </div>
                    <div class="avatar-circle dropdown-toggle" data-bs-toggle="dropdown">
                        {{ session.get('username')[0].upper() }}
                    </div>
                    <ul class="dropdown-menu dropdown-menu-end shadow border-0">
                        <li><a class="dropdown-item py-2" href="{{ url_for('logout') }}"><i
                                    class="fas fa-sign-out-alt text-danger me-2"></i> Cerrar Sesi√≥n</a></li>
                    </ul>
                </div>
            </header>
            {% endif %}

            <main class="content-body">
                {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show shadow-sm border-0" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                {% endfor %}
                {% endif %}
                {% endwith %}

                {% block content %}{% endblock %}
            </main>

            <!-- Floating Action Button -->
            <div class="fab-container">
                <a href="{{ url_for('agregar') }}" class="fab" title="Nuevo Ticket">
                    <i class="fas fa-plus"></i>
                </a>
            </div>
        </div>
    </div>

    {% if session.get('user_id') %}
    <!-- Mobile Bottom Navigation -->
    <nav class="mobile-bottom-nav d-lg-none">
        <a href="{{ url_for('dashboard') }}" class="nav-item {% if request.endpoint == 'dashboard' %}active{% endif %}">
            <i class="fas fa-home"></i>
            <span>Inicio</span>
        </a>
        <a href="{{ url_for('lista_soportes') }}"
            class="nav-item {% if request.endpoint == 'lista_soportes' %}active{% endif %}">
            <i class="fas fa-ticket-alt"></i>
            <span>Tickets</span>
        </a>
        {% if session.get('role') in ['admin', 'tecnico'] %}
        <a href="{{ url_for('lista_equipos') }}"
            class="nav-item {% if request.endpoint == 'lista_equipos' %}active{% endif %}">
            <i class="fas fa-laptop"></i>
            <span>Equipos</span>
        </a>
        {% endif %}
        <a href="#" id="mobileMenuToggle" class="nav-item">
            <i class="fas fa-bars"></i>
            <span>Men√∫</span>
        </a>
    </nav>
    {% endif %}

    <!-- Toast Container for Notifications -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 2000;">
        <div id="liveToast" class="toast border-0 shadow" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header bg-primary text-white border-0">
                <i class="fas fa-bell me-2"></i>
                <strong class="me-auto">Nuevo Ticket</strong>
                <small>Ahora</small>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"
                    aria-label="Close"></button>
            </div>
            <div class="toast-body glass-card">
                <p id="toastBody" class="mb-0 fw-600"></p>
                <div class="mt-2 pt-2 border-top">
                    <a href="{{ url_for('lista_soportes') }}" class="btn btn-primary btn-sm">Ver Ticket</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.4.1/js/dataTables.responsive.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.bootstrap5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.print.min.js"></script>

    <script>
        $(document).ready(function () {
            // Sidebar Toggle & Overlay Logic (Centralized)
            function toggleSidebar() {
                const sidebar = $('#sidebar');
                const overlay = $('#sidebarOverlay');

                sidebar.toggleClass('show');
                overlay.toggleClass('show');
                $('body').toggleClass('overflow-hidden');
            }

            // Bind all toggle triggers
            $('#sidebarToggle, #sidebarOverlay, #mobileMenuToggle').each(function () {
                $(this).on('click', function (e) {
                    if ($(this).is('a')) e.preventDefault();
                    toggleSidebar();
                });
            });

            // Auto-close sidebar when clicking a link on mobile
            $('.menu-link').on('click', function () {
                if ($(window).width() <= 992 && $('#sidebar').hasClass('show')) {
                    toggleSidebar();
                }
            });

            // Reset UI state on desktop resize
            $(window).on('resize', function () {
                if ($(window).width() > 992) {
                    $('#sidebar').removeClass('show');
                    $('#sidebarOverlay').removeClass('show');
                    $('body').removeClass('overflow-hidden');
                }
            });

            $('.tabla-enterprise').DataTable({
                responsive: true,
                order: [],
                dom: '<"row mb-3"<"col-md-6"B><"col-md-6"f>>rt<"row mt-3"<"col-md-6"i><"col-md-6"p>>',
                buttons: [
                    { extend: 'excel', className: 'btn btn-success btn-sm', text: '<i class="fas fa-file-excel"></i> Excel' },
                    { extend: 'pdf', className: 'btn btn-danger btn-sm', text: '<i class="fas fa-file-pdf"></i> PDF' },
                    { extend: 'print', className: 'btn btn-secondary btn-sm', text: '<i class="fas fa-print"></i> Imprimir' }
                ],
                language: { url: "//cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json" },
                pageLength: 15,
                initComplete: function () {
                    // Transition from skeleton to real table
                    $('#tableSkeleton').css('opacity', '0');
                    setTimeout(() => {
                        $('#tableSkeleton').hide();
                        $('.tabla-enterprise').removeClass('table-hidden').addClass('fade-in');
                    }, 400);
                }
            });

            // Theme Toggle Logic
            const themeToggle = $('#themeToggle');
            const themeIcon = $('#themeIcon');

            function updateIcon(theme) {
                if (theme === 'dark') {
                    themeIcon.removeClass('fa-moon').addClass('fa-sun');
                } else {
                    themeIcon.removeClass('fa-sun').addClass('fa-moon');
                }
            }

            // Set initial icon
            updateIcon(document.documentElement.getAttribute('data-theme'));

            themeToggle.on('click', function () {
                const currentTheme = document.documentElement.getAttribute('data-theme');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                updateIcon(newTheme);
            });

            // Socket.IO Real-time Notifications
            const socket = io();
            console.log("üîå Intentando conectar con Socket.IO...");

            socket.on('connect', () => {
                console.log("‚úÖ Conectado a Socket.IO con ID:", socket.id);
            });

            const toast = new bootstrap.Toast(document.getElementById('liveToast'));

            socket.on('new_ticket', function (data) {
                console.log("üì© Se recibi√≥ un nuevo ticket v√≠a Socket.IO:", data);
                const userRole = "{{ session.get('role') }}";
                console.log("üë§ Rol de usuario actual:", userRole);

                if (userRole === 'admin' || userRole === 'tecnico') {
                    // Actualizar Toast (Notificaci√≥n discreta)
                    $('#toastBody').html(`<strong>#${data.numero}</strong>: ${data.titulo}`);
                    toast.show();

                    // Alerta SweetAlert2 (Pop-up proactivo)
                    Swal.fire({
                        title: '¬°Nuevo Ticket Recibido!',
                        html: `Se ha creado el ticket <b>#${data.numero}</b><br><small>${data.titulo}</small>`,
                        icon: 'info',
                        toast: false,
                        position: 'center',
                        showConfirmButton: true,
                        confirmButtonText: '<i class="fas fa-eye"></i> Ver Ticket',
                        confirmButtonColor: '#3699ff',
                        showCancelButton: true,
                        cancelButtonText: 'Cerrar',
                        timer: 15000,
                        timerProgressBar: true,
                        background: 'var(--card-bg)',
                        color: 'var(--text-color)', // Corregido de --text-main
                        didOpen: () => {
                            // Sonido sutil
                            const audio = new Audio('https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3');
                            audio.play().catch(e => console.log("Audio block by browser"));
                        }
                    }).then((result) => {
                        if (result.isConfirmed) {
                            window.location.href = "{{ url_for('lista_soportes') }}";
                        }
                    });

                    // Auto-refrescar si estamos en la lista de soportes o dashboard
                    const path = window.location.pathname;
                    const isTicketPage = path.includes('/soportes') || path.includes('/dashboard') || path === '/';
                    const hasTicketsTable = $('.tabla-enterprise').length > 0;

                    console.log("üìç Ruta actual:", path);
                    console.log("üîç ¬øEs p√°gina de tickets/dashboard?:", isTicketPage);
                    console.log("üìä ¬øExiste la tabla de tickets?:", hasTicketsTable);

                    if (isTicketPage || hasTicketsTable) {
                        console.log("üîÑ Programando refresco de p√°gina en 3s...");
                        setTimeout(() => {
                            console.log("üöÄ Ejecutando location.reload() AHORA.");
                            window.location.reload(true); // Forzar recarga
                        }, 3000);
                    } else {
                        console.log("‚ÑπÔ∏è No se refresca: No se detect√≥ ruta de datos ni tabla activa.");
                    }
                } else {
                    console.log("‚ÑπÔ∏è Notificaci√≥n recibida pero ignorada por el rol del usuario (Rol actual: {{ session.get('role') }}).");
                }
            });

            // Form Validation Logic
            const forms = document.querySelectorAll('.needs-validation');
            Array.from(forms).forEach(form => {
                form.addEventListener('submit', event => {
                    if (!form.checkValidity()) {
                        event.preventDefault();
                        event.stopPropagation();
                    }
                    form.classList.add('was-validated');
                }, false);

                // Live validation while typing
                const inputs = form.querySelectorAll('input, textarea, select');
                inputs.forEach(input => {
                    input.addEventListener('input', () => {
                        if (form.classList.contains('was-validated')) {
                            // Already tried submitting
                        } else {
                            if (!input.checkValidity()) {
                                input.classList.add('is-invalid');
                                input.classList.remove('is-valid');
                            } else {
                                input.classList.remove('is-invalid');
                                input.classList.add('is-valid');
                            }
                        }
                    });
                });
            });
        });
    </script>
</body>

</html>