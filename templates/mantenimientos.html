{% extends "layout.html" %}

{% block content %}
<div class="card shadow h-100 border-0">
    <div class="card-header bg-white py-2 border-bottom d-flex justify-content-between align-items-center">
        <h5 class="mb-0 text-primary fw-bold"><i class="fas fa-clipboard-list"></i> Reporte y Gestión de Mantenimientos
        </h5>

        <div class="d-flex gap-2">
            <button class="btn btn-outline-dark btn-sm" type="button" data-bs-toggle="collapse"
                data-bs-target="#panelFiltros">
                <i class="fas fa-filter"></i> Generar Reporte
            </button>
            <a href="{{ url_for('programar_mantenimiento') }}" class="btn btn-warning btn-sm text-dark">
                <i class="fas fa-calendar-plus"></i> Programar Tarea
            </a>
        </div>
    </div>

    <div class="collapse bg-light border-bottom" id="panelFiltros">
        <div class="card-body">
            <form method="GET" action="{{ url_for('lista_mantenimientos') }}">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label small fw-bold">Desde:</label>
                        <input type="date" name="fecha_inicio" class="form-control form-control-sm"
                            value="{{ request.args.get('fecha_inicio', '') }}">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small fw-bold">Hasta:</label>
                        <input type="date" name="fecha_fin" class="form-control form-control-sm"
                            value="{{ request.args.get('fecha_fin', '') }}">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small fw-bold">Estado:</label>
                        <select name="estado" class="form-select form-select-sm">
                            <option value="Todos">Todos</option>
                            <option value="Pendiente" {% if request.args.get('estado')=='Pendiente' %}selected{% endif
                                %}>Pendiente</option>
                            <option value="Realizado" {% if request.args.get('estado')=='Realizado' %}selected{% endif
                                %}>Realizado</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small fw-bold">Equipo:</label>
                        <select name="equipo_id" class="form-select form-select-sm">
                            <option value="Todos">Todos</option>
                            {% for eq in equipos %}
                            <option value="{{ eq.id }}" {% if request.args.get('equipo_id')==(eq.id | string)
                                %}selected{% endif %}>{{ eq.nombre_equipo }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12 text-end">
                        <a href="{{ url_for('lista_mantenimientos') }}"
                            class="btn btn-outline-secondary btn-sm me-2">Limpiar</a>
                        <button type="submit" class="btn btn-primary btn-sm"><i class="fas fa-search"></i> Generar
                            Lista</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div class="card-body p-2">
        <table class="table table-striped table-hover tabla-enterprise w-100 align-middle">
            <thead>
                <tr>
                    <th>Fecha</th>
                    <th>Tarea / Título</th>
                    <th>Equipo</th>
                    <th>Estado</th>
                    <th>Técnico</th>
                    <th>Reprogramado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for mant in mantenimientos %}
                <tr>
                    <td data-order="{{ mant.fecha_programada }}">
                        <i class="far fa-calendar-alt text-muted me-1"></i>
                        {{ mant.fecha_programada }}
                    </td>

                    <td class="fw-bold">{{ mant.titulo }}</td>

                    <td>
                        <span class="badge bg-light text-dark border">
                            <i class="fas fa-laptop"></i> {{ mant.nombre_equipo }}
                        </span>
                    </td>

                    <td>
                        {% if mant.estado == 'Pendiente' %}
                        <span class="badge badge-glow-warning">Pendiente</span>
                        {% else %}
                        <span class="badge badge-glow-success">Realizado</span>
                        {% endif %}
                    </td>

                    <td>{{ mant.tecnico or '--' }}</td>

                    <td>
                        {% if mant.motivo_reprogramacion %}
                        <span class="text-danger small" title="{{ mant.motivo_reprogramacion }}">
                            <i class="fas fa-exclamation-triangle"></i> Sí
                        </span>
                        {% else %}
                        <span class="text-muted small">-</span>
                        {% endif %}
                    </td>

                    <td class="text-end">
                        <div class="d-flex gap-1 justify-content-end">
                            {% if mant.estado == 'Pendiente' %}
                            <button type="button" class="btn btn-success btn-sm" data-bs-toggle="modal"
                                data-bs-target="#modalCompletar{{ mant.id }}" title="Marcar Realizado">
                                <i class="fas fa-check"></i>
                            </button>

                            <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal"
                                data-bs-target="#modalReprogramar{{ mant.id }}" title="Reprogramar">
                                <i class="fas fa-clock"></i>
                            </button>
                            {% endif %}

                            {% if session['role'] == 'admin' %}
                            <form action="{{ url_for('eliminar_mantenimiento', mant_id=mant.id) }}" method="POST"
                                onsubmit="return confirm('¿Borrar tarea permanentemente?');">
                                <button class="btn btn-outline-danger btn-sm" title="Eliminar">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </form>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

{# Modales de Completar Mantenimiento #}
{% for mant in mantenimientos %}
{% if mant.estado == 'Pendiente' %}
<div class="modal fade text-start" id="modalCompletar{{ mant.id }}" tabindex="-1"
    aria-labelledby="modalCompletarLabel{{ mant.id }}" aria-hidden="true">
    <div class="modal-dialog">
        <form action="{{ url_for('completar_mantenimiento', mant_id=mant.id) }}" method="POST" class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="modalCompletarLabel{{ mant.id }}"><i class="fas fa-check-circle"></i>
                    Finalizar Mantenimiento</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Tarea: <strong>{{ mant.titulo }}</strong></p>
                <p class="text-muted small">Al finalizar, se enviará una notificación al usuario asignado.</p>
                <div class="mb-3">
                    <label class="form-label fw-bold">Comentarios y Observaciones</label>
                    <textarea name="comentarios" class="form-control" rows="4" required
                        placeholder="Describa el trabajo realizado, hallazgos o recomendaciones..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="submit" class="btn btn-success px-4">Finalizar Tarea</button>
            </div>
        </form>
    </div>
</div>
{% endif %}
{% endfor %}

{# Modales de Reprogramación (Fuera de la tabla para evitar problemas de Z-index) #}
{% for mant in mantenimientos %}
{% if mant.estado == 'Pendiente' %}
<div class="modal fade text-start" id="modalReprogramar{{ mant.id }}" tabindex="-1"
    aria-labelledby="modalLabel{{ mant.id }}" aria-hidden="true">
    <div class="modal-dialog">
        <form action="{{ url_for('reprogramar_mantenimiento', mant_id=mant.id) }}" method="POST" class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalLabel{{ mant.id }}">Cambiar Fecha de Mantenimiento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="mb-3">Tarea: <strong>{{ mant.titulo }}</strong></p>
                <div class="mb-3">
                    <label class="form-label fw-bold">Nueva Fecha Programada</label>
                    <input type="date" name="nueva_fecha" class="form-control" required>
                    <div class="form-text text-muted">La fecha actual es: {{ mant.fecha_programada }}</div>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">Motivo de la Reprogramación</label>
                    <textarea name="motivo" class="form-control" rows="3" required
                        placeholder="Explique brevemente por qué se cambia la fecha..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="submit" class="btn btn-primary px-4">Guardar Cambios</button>
            </div>
        </form>
    </div>
</div>
{% endif %}
{% endfor %}

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const urlParams = new URLSearchParams(window.location.search);
        const mantId = urlParams.get('id');
        if (mantId) {
            const modalEl = document.getElementById('modalReprogramar' + mantId);
            if (modalEl) {
                const modal = new bootstrap.Modal(modalEl);
                modal.show();
            }
        }
    });
</script>
{% endblock %}