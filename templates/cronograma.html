<!-- templates/cronograma.html (Versi√≥n Final con Modal Interactivo) -->

{% extends 'layout.html' %}

{% block title %}Cronograma de Mantenimiento{% endblock %}

{% block content %}
    <div class="dashboard-header">
        <h1>üóìÔ∏è Cronograma de Mantenimiento Anual</h1>
        <div class="dashboard-actions">
            <a href="{{ url_for('cronograma_estadisticas') }}" class="btn btn-primary">Ver Estad√≠sticas üìà</a>
        </div>
    </div>
    
    <p>Haz clic en una fecha para agendar un nuevo mantenimiento. Los eventos en <span style="color:#3498db; font-weight:bold;">azul</span> est√°n pendientes y los de color <span style="color:#2ecc71; font-weight:bold;">verde</span> ya fueron ejecutados.</p>

    <!-- Este div es donde se dibujar√° el calendario -->
    <div id="calendar" style="margin-top: 2em; background-color: white; padding: 1em; border-radius: 8px;"></div>

    <!-- =============================================================== -->
    <!-- VENTANA MODAL PARA AGREGAR MANTENIMIENTO -->
    <!-- =============================================================== -->
    <div id="add-event-modal" class="modal" style="display:none; position:fixed; z-index:1001; left:0; top:0; width:100%; height:100%; overflow:auto; background-color:rgba(0,0,0,0.5);">
        <div class="form-container" style="margin: 10% auto; max-width: 500px;">
            <h2>Agendar Nuevo Mantenimiento</h2>
            <form id="add-event-form">
                <div class="form-group">
                    <label for="fecha_programada">Fecha Programada:</label>
                    <input type="date" id="fecha_programada" name="fecha_programada" readonly style="background-color: #eee;">
                </div>
                <div class="form-group">
                    <label for="equipo_id">Seleccionar Equipo:</label>
                    <select id="equipo_id" name="equipo_id" required>
                        <option value="" disabled selected>-- Elige un equipo --</option>
                        {% for equipo in equipos %}
                        <option value="{{ equipo.id }}">{{ equipo.nombre_equipo }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="titulo">T√≠tulo del Mantenimiento:</label>
                    <input type="text" id="titulo" name="titulo" required placeholder="Ej: Limpieza de componentes internos">
                </div>
                <div style="display: flex; gap: 10px;">
                    <button type="submit" class="btn btn-primary" style="flex-grow: 1;">Guardar Mantenimiento</button>
                    <button type="button" id="cancel-btn" class="btn btn-danger" style="flex-grow: 1; background-color: #7f8c8d;">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

{% endblock %}


{% block scripts %}
<!-- Importamos la librer√≠a FullCalendar -->
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.13/index.global.min.js'></script>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    var calendarEl = document.getElementById('calendar');
    const modal = document.getElementById('add-event-modal');
    const form = document.getElementById('add-event-form');
    const fechaInput = document.getElementById('fecha_programada');
    const cancelBtn = document.getElementById('cancel-btn');

    var calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: 'dayGridMonth',
      headerToolbar: {
        left: 'prev,next today',
        center: 'title',
        right: 'dayGridMonth,timeGridWeek,listWeek'
      },
      locale: 'es',
      events: '/api/mantenimientos',
      selectable: true,

      // --- L√ìGICA PARA AGREGAR EVENTOS ---
      dateClick: function(info) {
        // Al hacer clic en una fecha, llenamos el campo y mostramos el modal
        fechaInput.value = info.dateStr;
        modal.style.display = 'block';
      },
      
      eventClick: function(info) {
        alert('Evento: ' + info.event.title + '\nEstado: ' + (info.event.backgroundColor === '#2ecc71' ? 'Ejecutado' : 'Pendiente'));
      }
    });

    calendar.render();

    // --- L√ìGICA DEL MODAL ---
    cancelBtn.addEventListener('click', () => {
        modal.style.display = 'none';
        form.reset();
    });

    form.addEventListener('submit', function(e) {
        e.preventDefault(); // Evitamos que la p√°gina se recargue

        const formData = new FormData(form);

        fetch("{{ url_for('agregar_mantenimiento') }}", {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Si todo fue bien, cerramos el modal y refrescamos el calendario
                modal.style.display = 'none';
                form.reset();
                calendar.refetchEvents(); // ¬°Esta l√≠nea actualiza el calendario!
                alert('¬°Mantenimiento agendado con √©xito!');
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Ocurri√≥ un error al guardar el mantenimiento.');
        });
    });

  });
</script>
{% endblock %}